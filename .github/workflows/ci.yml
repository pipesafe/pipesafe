name: CI

on:
  pull_request:
    branches: [main]

env:
  BUN_VERSION: 1.2.17

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages
        run: bun run build

      - name: Test
        run: bun run test:ci

  format:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Format check
        run: bun run format

  typecheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages
        run: bun run build

      - name: Type check
        run: bun run typecheck

  changeset:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for changeset
        run: |
          if [ "${{ github.event.pull_request.head.ref }}" = "changeset-release/main" ]; then
            echo "Skipping changeset check for release PR"
            exit 0
          fi
          bun run changeset:status

  version-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check package versions have not changed
        run: |
          if [ "${{ github.event.pull_request.head.ref }}" = "changeset-release/main" ]; then
            echo "Skipping version check for release PR"
            exit 0
          fi

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HAS_ERROR=0

          # Check each publishable package
          for PKG in packages/core packages/manifold; do
            PKG_NAME=$(basename $PKG)
            PKG_JSON="$PKG/package.json"

            # Get base version
            git show $BASE_SHA:$PKG_JSON > /tmp/package-base.json 2>/dev/null || {
              echo "⚠️  Package $PKG_NAME is new (not in base branch)"
              continue
            }
            BASE_VERSION=$(node -p "require('/tmp/package-base.json').version")

            # Get PR version
            PR_VERSION=$(node -p "require('./$PKG_JSON').version")

            echo "Package: $PKG_NAME"
            echo "  Base version: $BASE_VERSION"
            echo "  PR version: $PR_VERSION"

            if [ "$BASE_VERSION" != "$PR_VERSION" ]; then
              echo "❌ Error: Version should not be changed in PR for $PKG_NAME!"
              HAS_ERROR=1
            else
              echo "  ✅ Version unchanged"
            fi
            echo ""
          done

          if [ "$HAS_ERROR" = "1" ]; then
            echo "Version changes should be done automatically by the publish workflow after merge."
            echo "Please revert the version change(s) in the package.json file(s)"
            exit 1
          fi

          echo "✅ All version checks passed"
